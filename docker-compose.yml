services:
  timescaledb:
    image: timescale/timescaledb:latest-pg16
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-solar_db}
    volumes:
      - timescaledb_data:/var/lib/postgresql/data
      - ./schema.sql:/docker-entrypoint-initdb.d/schema.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    restart: unless-stopped
    command: -c shared_preload_libraries=timescaledb
    env_file:
      - .env

  redis:
    image: redis:7
    command: --requirepass ${REDIS_PASSWORD:-redis_password}
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    env_file:
      - .env

  airflow:
    image: apache/airflow:2.10.0-python3.12
    environment:
      PYTHONPATH: /opt/airflow/backend:/opt/airflow/dags
      AIRFLOW__CORE__EXECUTOR: CeleryExecutor
      AIRFLOW__CELERY__BROKER_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@timescaledb:5432/${POSTGRES_DB:-solar_db}
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@timescaledb:5432/${POSTGRES_DB:-solar_db}
      AIRFLOW__CORE__LOAD_EXAMPLES: "false"
      POSTGRES_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@timescaledb:5432/${POSTGRES_DB:-solar_db}
      COMPANY_KEY: ${COMPANY_KEY:-your_key}
      _AIRFLOW_DB_MIGRATE: "true"
      _AIRFLOW_WWW_USER_CREATE: "true"
      _AIRFLOW_WWW_USER_USERNAME: ${AIRFLOW_USER:-admin}
      _AIRFLOW_WWW_USER_PASSWORD: ${AIRFLOW_PASSWORD:-admin}
    volumes:
      - ./backend/dags:/opt/airflow/dags
      - ./backend:/opt/airflow/backend
    ports:
      - "8080:8080"
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: >
      bash -c "
        pip install -e /opt/airflow/backend &&
        airflow db migrate &&
        airflow users create \
          --username ${AIRFLOW_USER:-admin} \
          --firstname Admin \
          --lastname User \
          --role Admin \
          --email admin@example.com \
          --password ${AIRFLOW_PASSWORD:-admin} || true &&
        airflow scheduler & 
        airflow webserver
      "
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
    env_file:
      - .env

  celery-worker:
    image: python:3.12-slim
    command: celery -A app.ingestion.tasks worker --loglevel=info
    volumes:
      - ./backend:/app/backend
    depends_on:
      redis:
        condition: service_healthy
      timescaledb:
        condition: service_healthy
    environment:
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@timescaledb:5432/${POSTGRES_DB:-solar_db}
    restart: unless-stopped
    env_file:
      - .env

  fastapi:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ./backend:/app/backend
    depends_on:
      timescaledb:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@timescaledb:5432/${POSTGRES_DB:-solar_db}
      REDIS_URL: redis://:${REDIS_PASSWORD:-redis_password}@redis:6379/0
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      ALGORITHM: ${ALGORITHM:-HS256}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      COMPANY_KEY: ${COMPANY_KEY:-your_key}
      FLASK_ENV: ${FLASK_ENV:-development}  # Use 'production' for prod
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      BATCH_SIZE: ${BATCH_SIZE:-1000}
      SOLARMAN_EMAIL: ${SOLARMAN_EMAIL}
      SOLARMAN_PASSWORD_SHA256: ${SOLARMAN_PASSWORD_SHA256}
      SOLARMAN_APP_ID: ${SOLARMAN_APP_ID}
      SOLARMAN_APP_SECRET: ${SOLARMAN_APP_SECRET}
    ports:
      - "8000:8000"
    command: ["gunicorn", "-w", "4", "-k", "uvicorn.workers.UvicornWorker", "--bind", "0.0.0.0:8000", "app.main:app"]
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 40s
    restart: unless-stopped
    env_file:
      - .env

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    volumes:
      - ./frontend:/app/frontend
      - frontend_node_modules:/app/frontend/node_modules
    ports:
      - "3000:3000"
    command: ["npm", "run", "dev"]
    depends_on:
      fastapi:
        condition: service_healthy
    environment:
      VITE_API_URL: http://fastapi:8000
    restart: unless-stopped
    env_file:
      - .env

  pgadmin:
    image: dpage/pgadmin4:latest
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@admin.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
    ports:
      - "5050:80"
    depends_on:
      timescaledb:
        condition: service_healthy
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    restart: unless-stopped
    env_file:
      - .env

volumes:
  timescaledb_data:
    driver: local
  pgadmin_data:
    driver: local
  frontend_node_modules:
    driver: local

networks:
  default:
    driver: bridge